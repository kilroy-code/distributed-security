<!DOCTYPE html>
<html style="font-family: sans-serif">
  <head>
    <meta charset="utf-8" />
  </head>
  <body>

    <h3>Vault</h3>
    <div id="log"></div>


    <script type="module">
import dispatch from '../jsonrpc/index.mjs';
// import assert isn't yet supported across browsers...
// import pkg from './package.json' assert {type: 'json'};
// so hardcode the label.
const pkg = {name: "@kilroy-code/distributed-security", version: "0.0.2"};

function log(...args) { // Log message to element named "log".
  console.log(...args);
  // Use a fragment: browser will only render/reflow once.
  let message = args.join(' '),
      fragment = document.createDocumentFragment();
  fragment.appendChild(document.createTextNode(message));
  fragment.appendChild(document.createElement('br'));
  document.querySelector("#log").appendChild(fragment);
}

//log(`vault location: ${location.href}, referrer: ${document.referrer}`);
const hostOrigin = document.referrer ? new URL(document.referrer).origin : '*',
      url = import.meta.url,
      vaultOrigin = new URL('./lib/worker.mjs', url),
      api = {
	sign(message, ...tags) { return postWorker('sign', message, ...tags); },
	verify(signature, ...tags) { return postWorker('verify', signature, ...tags); },
	encrypt(message, ...tags) { return postWorker('encrypt', message, ...tags); },
	decrypt(encrypted, tag) { return postWorker('decrypt', encrypted, tag); },
	create(...optionalMembers) { return postWorker('create', ...optionalMembers); },
	changeMembership(options) { return postWorker('changeMembership', options); },
	destroy(tagOrOptions) { return postWorker('destroy', tagOrOptions); },
	clear(tag) { return postWorker('clear', tag); }
      },
      postClient = dispatch({
	dispatcherLabel: url,
	target: parent,
	targetLabel: parent.location.href,
	receiver: self,
	namespace: api,
	origin: hostOrigin
      }),
      hostAPI = {
	store(resourceTag, ownerTag, string, signature) {
	  return postClient('store', resourceTag, ownerTag, string, signature);
	},
	retrieve(resourceTag, ownerTag) {
	  return postClient('retrieve', resourceTag, ownerTag);
	},
	getUserDeviceSecret(...args) {
	  return postClient('getUserDeviceSecret', ...args);
	}
      },
      worker = new Worker(vaultOrigin, {type: 'module'}),
      postWorker = dispatch({
	dispatcherLabel: url,
	target: worker,
	targetLabel: 'worker',
	namespace: hostAPI
      });
postClient('ready', `${pkg.name} ${pkg.version} ${location.origin}`);
    </script>
  </body>
</html>
