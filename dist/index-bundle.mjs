const e=new URL(import.meta.url).origin;async function t(e){if(404===e.status)return"";if(!e.ok)return Promise.reject(e.statusText);let t=await e.text();return t?JSON.parse(t):t}const r={get origin(){return e},tagPath:function(e,t,r="json"){return t?`${e}/${t}.${r}`:e},uri(t,r){return`${e}/Storage/${this.tagPath(t,r)}`},store(e,r,n,o={}){return fetch(this.uri(e,r),{method:"PUT",body:JSON.stringify(n),headers:{"Content-Type":"application/json",...o.headers||{}}}).then(t)},retrieve(e,r,n={}){return fetch(this.uri(e,r),{cache:"default",headers:{Accept:"application/json",...n.headers||{}}}).then(t)}};var n=e=>e;"undefined"!=typeof window&&(n=window.prompt);var o=crypto;const a=new TextEncoder,i=new TextDecoder;const s=e=>(e=>{let t=e;"string"==typeof t&&(t=a.encode(t));const r=[];for(let e=0;e<t.length;e+=32768)r.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return btoa(r.join(""))})(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),c=e=>{let t=e;t instanceof Uint8Array&&(t=i.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return(e=>{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r})(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};function l(e){let t;if("string"==typeof e){const r=e.split(".");3!==r.length&&5!==r.length||([t]=r)}else if("object"==typeof e&&e){if(!("protected"in e))throw new TypeError("Token does not contain a Protected Header");t=e.protected}try{if("string"!=typeof t||!t)throw new Error;const e=JSON.parse(i.decode(c(t)));if(!function(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}(e))throw new Error;return e}catch{throw new TypeError("Invalid Token or Protected Header formatting")}}async function d(e){let t=await o.subtle.digest("SHA-256",e);return new Uint8Array(t)}const g=new URL(import.meta.url),u=new URL("vault.html",g),p=g.href,f=document.createElement("iframe"),h=new MessageChannel,y=Object.assign({log(...e){console.log(...e)},getUserDeviceSecret:function(e,t){return t?e+n(t):e}},r),m=new Promise((e=>{y.ready=e,f.style.display="none",document.body.append(f),f.setAttribute("src",u),h.port1.start(),f.onload=()=>f.contentWindow.postMessage(p,u.origin,[h.port2])})),w=function({target:e=self,receiver:t=e,namespace:r=t,origin:n=e!==t&&e.location.origin,dispatcherLabel:o=r.name||t.name||t.location?.href||t,targetLabel:a=e.name||n||e.location?.href||e,log:i=null,info:s=console.info.bind(console),warn:c=console.warn.bind(console),error:l=console.error.bind(console)}){const d={},g="2.0",u=e.postMessage.bind(e),p=n?e=>u(e,n):u;let f=0;return t.addEventListener("message",(async function(t){i?.(o,"got message",t.data,"from",a,t.origin);let{id:s,method:u,params:f=[],result:h,error:y,jsonrpc:m}=t.data||{};if(t.source&&t.source!==e)return l?.(o,"to",a,"got message from",t.source);if(n&&n!==t.origin)return l?.(o,n,"mismatched origin",a,t.origin);if(m!==g)return c?.(`${o} ignoring non-jsonrpc message ${JSON.stringify(t.data)}.`);if(u){let e,t=null,n=Array.isArray(f)?f:[f];try{e=await r[u](...n)}catch(e){t=function(e){let{name:t,message:r,code:n,data:o}=e;return{name:t,message:r,code:n,data:o}}(e),r[u]||t.message.includes(u)?t.message||(t.message=`${t.name||t.toString()} in ${u}.`):(t.message=`${u} is not defined.`,t.code=-32601)}if(void 0===s)return;let c=t?{id:s,error:t,jsonrpc:g}:{id:s,result:e,jsonrpc:g};return i?.(o,"answering",s,t||e,"to",a),p(c)}let w=d[s];if(delete d[s],!w)return c?.(`${o} ignoring response ${t.data}.`);y?w.reject(y):w.resolve(h)})),s?.(`${o} will dispatch to ${a}`),function(e,...t){let r=++f,n=d[r]={};return new Promise(((s,c)=>{i?.(o,"request",r,e,t,"to",a),Object.assign(n,{resolve:s,reject:c}),p({id:r,method:e,params:t,jsonrpc:g})}))}}({dispatcherLabel:"entry!"+p,namespace:y,target:h.port1,targetLabel:"vault!"+p}),b={sign:(e,...t)=>w("sign",e,...t),verify:(e,...t)=>w("verify",e,...t),encrypt:(e,...t)=>w("encrypt",e,...t),decrypt:(e,...t)=>w("decrypt",e,...t),create:(...e)=>w("create",...e),changeMembership:({tag:e,add:t,remove:r}={})=>w("changeMembership",{tag:e,add:t,remove:r}),destroy:e=>w("destroy",e),clear:(e=null)=>w("clear",e),wipeDeviceKeys:()=>w("wipeDeviceKeys"),ready:m,hashBuffer:d,hashText:function(e){return d((new TextEncoder).encode(e))},encodeBase64url:function(e){return s(e)},decodeBase64url:function(e){return c(e)},decodeClaims:function(e,t=0){return l(e.signatures?.[t]||e)},get Storage(){return y},set Storage(e){Object.assign(y,e)},get getUserDeviceSecret(){return y.getUserDeviceSecret},set getUserDeviceSecret(e){y.getUserDeviceSecret=e}};export{b as default};
