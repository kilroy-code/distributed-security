const e=location.origin;function t(t,r){return`${e}/db/${t}/${r}.json`}async function r(e){if(404===e.status)return"";if(!e.ok)return Promise.reject(e.statusText);let t=await e.text();return t?JSON.parse(t):t}const n={get origin(){return e},store:(e,n,o)=>fetch(t(e,n),{method:"PUT",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then(r),retrieve:(e,n)=>fetch(t(e,n),{cache:"default",headers:{Accept:"application/json"}}).then(r)};var o=e=>e;"undefined"!=typeof window&&(o=window.prompt);const s=import.meta.url,i=new URL("vault-bundle.mjs",s),a=document.createElement("iframe"),c={log(...e){console.log(...e)}},d={sign:(e,...t)=>l("sign",e,...t),verify:(e,...t)=>l("verify",e,...t),encrypt:(e,...t)=>l("encrypt",e,...t),decrypt:(e,...t)=>l("decrypt",e,...t),create:(...e)=>l("create",...e),changeMembership:({tag:e,add:t,remove:r}={})=>l("changeMembership",{tag:e,add:t,remove:r}),destroy:e=>l("destroy",e),clear:(e=null)=>l("clear",e),set Storage(e){Object.assign(c,e)},set getUserDeviceSecret(e){c.getUserDeviceSecret=e},ready:new Promise((e=>{c.ready=e,a.style.display="none",document.body.append(a),a.setAttribute("srcdoc",`<!DOCTYPE html><html><body><script type="module" src="${i.href}"><\/script></body></html>`)}))},l=function({target:e,receiver:t=e,namespace:r=t,origin:n=e!==t&&e.location.origin,log:o=(()=>null),warn:s=console.warn.bind(console),error:i=console.error.bind(console)}){let a={},c=0,d="2.0",l=n||e,g=e.postMessage.bind(e),m=n?e=>g(e,n):g;return o("dispatch to",l),t.addEventListener("message",(async t=>{o("message",t.data,"from",t.origin||l);let{id:c,method:g,params:u=[],result:p,error:f,jsonrpc:y}=t.data||{};if(t.source&&t.source!==e)return i("mismatched target:",e,t.source);if(n&&n!==t.origin)return i("mismatched origin",n,t.origin);if(y!==d)return s(`Ignoring non-jsonrpc message ${JSON.stringify(t.data)}.`);if(g){let e,t=null,n=Array.isArray(u)?u:[u];try{e=await r[g](...n)}catch(e){t=function(e){let{name:t,message:r}=e;return{name:t,message:r}}(e),r[g]||t.message.includes(g)?t.message||(t.message=`${t.name||t.toString()} in ${g}.`):t.message=`${g} is not defined.`}let s=t?{id:c,error:t,jsonrpc:d}:{id:c,result:e,jsonrpc:d};return o("answering",c,t||e,"to",l),m(s)}let h=a[c];if(delete a[c],!h)return console.log(`Ignoring response ${t.data}.`);f?h.reject(f):h.resolve(p)})),function(e,...t){let r=++c,n=a[r]={};return new Promise(((s,i)=>{Object.assign(n,{resolve:s,reject:i}),o("posting",r,e,t,"to",l),m({id:r,method:e,params:t,jsonrpc:d})}))}}({dispatcherLabel:s,target:a.contentWindow,targetLabel:"vault",receiver:self,origin:i.origin,namespace:c});d.Storage=n,d.getUserDeviceSecret=function(e,t){return t?e+o(t):e};export{d as default};
