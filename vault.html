<!DOCTYPE html>
<html style="font-family: sans-serif">
  <head>
    <meta charset="utf-8" />
  </head>
  <body>

    <h3>Vault</h3>
    See <a href="https://kilroy-code.github.io/distributed-security/docs/implementation.html#creating-the-vault-web-worker-and-iframe">implmentation.md</a>
  

    <script type="module">
import dispatch from './dependency/jsonrpc.mjs';
// import assert isn't yet supported across browsers, e.g....
//    import pkg from './package.json' assert {type: 'json'};
// so hardcode the label.
const pkg = {name: "@kilroy-code/distributed-security", version: "0.0.2"};

// We don't just blindly forward messages in either direction. There is a specific set of operations.
const api = { // jsonrpc requests from the client are handled by these, which answers them by making requests to the worker.
	sign(message, ...tags) { return postWorker('sign', message, ...tags); },
	verify(signature, ...tags) { return postWorker('verify', signature, ...tags); },
	encrypt(message, ...tags) { return postWorker('encrypt', message, ...tags); },
	decrypt(encrypted, tag) { return postWorker('decrypt', encrypted, tag); },
	create(...optionalMembers) { return postWorker('create', ...optionalMembers); },
	changeMembership(options) { return postWorker('changeMembership', options); },
	destroy(tagOrOptions) { return postWorker('destroy', tagOrOptions); },
	clear(tag) { return postWorker('clear', tag); }
      },

      hostAPI = { // jsonrpc request from the worker are handled by thise, which answers them by make requests to the client.
	store(resourceTag, ownerTag, signature) {
	  return postClient('store', resourceTag, ownerTag, signature);
	},
	retrieve(resourceTag, ownerTag) {
	  return postClient('retrieve', resourceTag, ownerTag);
	},
	getUserDeviceSecret(...args) {
	  return postClient('getUserDeviceSecret', ...args);
	},
	ready() {
	  postClient('ready', `${pkg.name} ${pkg.version} ${location.origin}`);
	}
      },

      // Sets up the jsonrpc  connection to the client (index.mjs).
      hostOrigin = document.referrer ? new URL(document.referrer).origin : '*',
      url = location.href,
      postClient = dispatch({
	dispatcherLabel: url,
	target: parent,
	targetLabel: 'entry',
	receiver: self,
	namespace: api,
	origin: hostOrigin
      }),

      // Sets up the jsonrpc connection to the worker.
      vaultOrigin = new URL('./lib/worker.mjs', url),
      worker = new Worker(vaultOrigin, {type: 'module'}),
      postWorker = dispatch({
	dispatcherLabel: url,
	target: worker,
	targetLabel: 'worker',
	namespace: hostAPI
      });

    </script>
  </body>
</html>
